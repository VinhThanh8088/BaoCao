<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Báo Cáo Chuyên Nghiệp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .sidebar-icon { width: 24px; height: 24px; }
        .chart-container { position: relative; width: 100%; margin-left: auto; margin-right: auto; height: 250px; }
        @media (min-width: 640px) { .chart-container { height: 300px; } }
        @media (min-width: 768px) { .chart-container { height: 350px; } }
        .chart-container { max-height: 400px; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .kpi-card { transition: all 0.2s ease-in-out; }
        .kpi-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.05), 0 4px 6px -4px rgb(0 0 0 / 0.05); }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #f59e0b; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>

<body class="bg-slate-100 text-slate-800">
    <div id="loading-state" class="flex items-center justify-center h-screen">
        <div class="text-center p-4">
            <div class="spinner mx-auto mb-4"></div>
            <h2 class="text-2xl font-semibold text-slate-700 mb-2">Đang tải dữ liệu...</h2>
            <p class="text-slate-500">Vui lòng chờ trong giây lát.</p>
        </div>
    </div>

    <div id="error-state" class="hidden flex items-center justify-center h-screen">
        <div class="text-center p-4">
            <h2 class="text-2xl font-semibold text-rose-700 mb-2">Lỗi Dữ Liệu</h2>
            <p class="text-slate-500 mb-4">Dữ liệu trong URL không hợp lệ hoặc bị hỏng.</p>
            <button onclick="window.location.reload()" class="bg-amber-500 text-white px-4 py-2 rounded-md hover:bg-amber-600">Tải lại</button>
        </div>
    </div>

    <div id="app-container" class="hidden h-screen flex-col sm:flex-row">
        <aside class="w-full sm:w-20 md:w-64 bg-white border-b sm:border-b-0 sm:border-r border-slate-200 flex flex-col shrink-0">
            <div class="h-16 flex items-center justify-center md:justify-start md:px-6 border-b sm:border-b-0 border-slate-200 shrink-0">
                <div class="bg-amber-500 text-white w-10 h-10 rounded-lg flex items-center justify-center text-xl font-bold">S</div>
                <span class="hidden md:inline ml-4 text-lg font-semibold text-amber-600">ERP Report</span>
            </div>
            <nav id="main-nav" class="flex-1 pt-2 sm:pt-6 space-y-2 flex sm:flex-col flex-row justify-around sm:justify-start">
                <a href="#tongQuan" class="nav-link flex flex-col sm:flex-row items-center py-3 px-2 sm:px-6 text-center">
                    <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                    <span class="text-xs sm:text-sm md:text-base hidden md:inline sm:ml-4 font-medium">Tổng Quan</span>
                </a>
                <a href="#phanTichBanHang" class="nav-link flex flex-col sm:flex-row items-center py-3 px-2 sm:px-6 text-center">
                    <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                    <span class="text-xs sm:text-sm md:text-base hidden md:inline sm:ml-4 font-medium">Bán Hàng</span>
                </a>
                <a href="#khoHang" class="nav-link flex flex-col sm:flex-row items-center py-3 px-2 sm:px-6 text-center">
                    <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>
                    <span class="text-xs sm:text-sm md:text-base hidden md:inline sm:ml-4 font-medium">Kho Hàng</span>
                </a>
                <a href="#khachHang" class="nav-link flex flex-col sm:flex-row items-center py-3 px-2 sm:px-6 text-center">
                    <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    <span class="text-xs sm:text-sm md:text-base hidden md:inline sm:ml-4 font-medium">Khách Hàng</span>
                </a>
            </nav>
        </aside>

        <main class="flex-1 p-4 md:p-8 overflow-y-auto">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                <h1 id="view-title" class="text-2xl sm:text-3xl font-bold text-slate-800"></h1>
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <span class="text-sm font-medium text-slate-500">Giai đoạn:</span>
                    <select id="date-filter" class="bg-white border border-slate-300 rounded-md shadow-sm px-3 py-2 text-sm font-medium text-slate-700 focus:outline-none focus:ring-2 focus:ring-amber-500">
                        <option value="7">7 ngày qua</option>
                        <option value="30" selected>30 ngày qua</option>
                        <option value="90">90 ngày qua</option>
                        <option value="365">1 năm qua</option>
                        <option value="9999">Tất cả</option>
                    </select>
                </div>
            </div>
            <div id="views-container"></div>
        </main>
    </div>

    <template id="view-template-tongQuan">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-6 rounded-xl border border-slate-200 kpi-card"><h3 class="text-slate-500 text-sm font-medium mb-2">Tổng Doanh Thu</h3><p id="kpi-doanh-thu" class="text-2xl md:text-3xl font-bold text-amber-600">0đ</p></div>
            <div class="bg-white p-6 rounded-xl border border-slate-200 kpi-card"><h3 class="text-slate-500 text-sm font-medium mb-2">Tổng Lợi Nhuận</h3><p id="kpi-loi-nhuan" class="text-2xl md:text-3xl font-bold text-emerald-600">0đ</p></div>
            <div class="bg-white p-6 rounded-xl border border-slate-200 kpi-card"><h3 class="text-slate-500 text-sm font-medium mb-2">Tổng Đơn Hàng</h3><p id="kpi-don-hang" class="text-2xl md:text-3xl font-bold text-sky-600">0</p></div>
            <div class="bg-white p-6 rounded-xl border border-slate-200 kpi-card"><h3 class="text-slate-500 text-sm font-medium mb-2">Tỷ Lệ Lợi Nhuận</h3><p id="kpi-ty-le-loi-nhuan" class="text-2xl md:text-3xl font-bold text-violet-600">0%</p></div>
        </div>
        <div class="bg-white p-6 rounded-xl border border-slate-200 mb-8">
            <h3 class="text-lg font-semibold mb-4">Tổng Quan Doanh Thu & Lợi Nhuận</h3>
            <div class="chart-container"><canvas id="overviewChart"></canvas></div>
            <p data-chart-empty-message for="overviewChart" class="hidden text-center text-slate-500 mt-4">Không có dữ liệu để hiển thị biểu đồ.</p>
        </div>
    </template>

    <template id="view-template-phanTichBanHang">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white p-6 rounded-xl border border-slate-200">
                <h3 class="text-lg font-semibold mb-4">Phân Bổ Doanh Thu Theo Loại Sản Phẩm</h3>
                <div class="chart-container"><canvas id="categorySalesChart"></canvas></div>
                <p data-chart-empty-message for="categorySalesChart" class="hidden text-center text-slate-500 mt-4">Không có dữ liệu để hiển thị biểu đồ.</p>
            </div>
            <div class="bg-white p-6 rounded-xl border border-slate-200">
                <h3 class="text-lg font-semibold mb-4">Top 5 Sản Phẩm Doanh Thu Cao Nhất</h3>
                <div class="chart-container"><canvas id="topProductRevenueChart"></canvas></div>
                <p data-chart-empty-message for="topProductRevenueChart" class="hidden text-center text-slate-500 mt-4">Không có dữ liệu để hiển thị biểu đồ.</p>
            </div>
        </div>
    </template>

    <template id="view-template-khoHang">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1 flex flex-col gap-8">
                <div class="bg-white p-6 rounded-xl border border-slate-200 kpi-card"><h3 class="text-slate-500 text-sm font-medium mb-2">Tổng Giá Trị Tồn Kho</h3><p id="kpi-gia-tri-kho" class="text-2xl md:text-3xl font-bold text-slate-800">0đ</p></div>
                <div class="bg-white p-6 rounded-xl border border-slate-200 kpi-card"><h3 class="text-slate-500 text-sm font-medium mb-2">Sản Phẩm Sắp Hết Hàng</h3><p id="kpi-sap-het-hang" class="text-2xl md:text-3xl font-bold text-rose-500">0</p></div>
            </div>
            <div class="lg:col-span-2 bg-white p-6 rounded-xl border border-slate-200">
                <h3 class="text-lg font-semibold mb-4">Danh Sách Sản Phẩm Cần Nhập Hàng</h3>
                <div class="max-h-[60vh] overflow-y-auto">
                    <table class="w-full text-sm text-left"><thead class="text-xs text-slate-500 uppercase bg-slate-100 sticky top-0"><tr><th class="px-4 py-3">Sản Phẩm</th><th class="px-4 py-3 text-center">Tồn Kho</th><th class="px-4 py-3 text-center">Mức Tối Thiểu</th></tr></thead><tbody id="lowStockTableBody"></tbody></table>
                </div>
            </div>
        </div>
    </template>

    <template id="view-template-khachHang">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white p-6 rounded-xl border border-slate-200">
                <h3 class="text-lg font-semibold mb-4">Top 5 Khách Hàng Chi Tiêu Nhiều Nhất</h3>
                <div class="chart-container"><canvas id="topCustomerChart"></canvas></div>
                <p data-chart-empty-message for="topCustomerChart" class="hidden text-center text-slate-500 mt-4">Không có dữ liệu để hiển thị biểu đồ.</p>
            </div>
            <div class="bg-white p-6 rounded-xl border border-slate-200"><h3 class="text-lg font-semibold mb-4">Phân Bổ Khách Hàng</h3><div class="grid grid-cols-2 gap-4 pt-4"><div class="text-center"><p class="text-3xl md:text-4xl font-bold text-sky-600" id="total-customers">0</p><p class="text-sm text-slate-500 mt-1">Tổng số khách hàng</p></div><div class="text-center"><p class="text-3xl md:text-4xl font-bold text-emerald-600" id="new-customers">0</p><p class="text-sm text-slate-500 mt-1">Khách hàng mới (trong kỳ)</p></div></div></div>
        </div>
    </template>

<script>
/**
 * DashboardApp Module
 * Đóng gói toàn bộ logic của ứng dụng dashboard để tránh biến toàn cục,
 * giúp code sạch sẽ, dễ quản lý và mở rộng.
 */
const DashboardApp = {
    // --- STATE & DATA ---
    state: {
        currentView: 'tongQuan',
        charts: {},
        database: { sanPhams: [], khachHangs: [], donHangs: [], chiTietDonHangs: [], chiTietPhieuNhaps: [] },
        // Dữ liệu đã được xử lý để tối ưu hiệu suất
        maps: {
            sanPham: new Map(),
            khachHang: new Map(),
        }
    },

    // --- UTILITY & HELPER FUNCTIONS ---
    _helpers: {
        formatCurrency: (value) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value),
        parseNumber: (value) => {
            const num = Number(value);
            return isNaN(num) ? 0 : num;
        },
        parseDate: (dateStr) => {
            if (!dateStr) return null;
            // Định dạng mong đợi: MM/DD/YYYY HH:mm:ss
            const parts = dateStr.split(/[\s/:]+/);
            if (parts.length < 3) return null;
            const [month, day, year, hour = 0, minute = 0, second = 0] = parts;
            // Lưu ý: Tháng trong new Date() bắt đầu từ 0 (0 = Tháng 1)
            const date = new Date(year, month - 1, day, hour, minute, second);
            return isNaN(date.getTime()) ? null : date;
        },
        updateText: (selector, value) => {
            const el = document.querySelector(selector);
            if (el) el.textContent = value;
        },
        createOrUpdateChart: (chartId, type, data, options) => {
            const chartContainer = document.querySelector(`canvas#${chartId}`).parentElement;
            const emptyMessage = document.querySelector(`[data-chart-empty-message][for="${chartId}"]`);

            // Hủy biểu đồ cũ nếu tồn tại
            if (DashboardApp.state.charts[chartId]) {
                DashboardApp.state.charts[chartId].destroy();
            }

            // Kiểm tra dữ liệu rỗng
            const hasData = data.datasets.some(dataset => dataset.data && dataset.data.length > 0);

            if (!hasData) {
                chartContainer.classList.add('hidden');
                emptyMessage?.classList.remove('hidden');
                return;
            }
            
            chartContainer.classList.remove('hidden');
            emptyMessage?.classList.add('hidden');

            const ctx = document.getElementById(chartId).getContext('2d');
            DashboardApp.state.charts[chartId] = new Chart(ctx, { type, data, options });
        }
    },

    // --- DATA LOADING & PROCESSING ---
    _loadDataFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        const dataParam = urlParams.get('data');
        if (!dataParam) return false;

        try {
            // CẢNH BÁO: Sử dụng atob không an toàn nếu dữ liệu không được kiểm soát.
            // Bỏ qua bước mã hóa theo yêu cầu.
            const decodedData = JSON.parse(decodeURIComponent(dataParam));
            this.state.database = {
                sanPhams: decodedData.sanPhams || [],
                khachHangs: decodedData.khachHangs || [],
                donHangs: decodedData.donHangs || [],
                chiTietDonHangs: decodedData.chiTietDonHangs || [],
                chiTietPhieuNhaps: decodedData.chiTietPhieuNhaps || []
            };
            return true;
        } catch (e) {
            console.error("Lỗi giải mã dữ liệu từ URL:", e);
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('error-state').classList.remove('hidden');
            return false;
        }
    },
    
    _createLookupMaps() {
        // Tối ưu hiệu suất: Tạo map để tra cứu nhanh thay vì dùng .find() trong vòng lặp
        this.state.maps.sanPham = new Map(this.state.database.sanPhams.map(p => [p.MaSP, p]));
        this.state.maps.khachHang = new Map(this.state.database.khachHangs.map(k => [k.MaKH, k]));
    },

    _processData() {
        const h = this._helpers;
        const db = this.state.database;
        
        const days = parseInt(document.getElementById('date-filter').value);
        const startDate = new Date();
        startDate.setHours(0, 0, 0, 0);
        if (days < 9999) {
            startDate.setDate(startDate.getDate() - days);
        } else {
             startDate.setFullYear(1970); // Nếu là "Tất cả", lấy từ thời gian rất xa
        }
        
        // 1. Lọc đơn hàng hợp lệ trong khoảng thời gian đã chọn
        const filteredDonHangs = db.donHangs.filter(dh => {
            if (!dh.NgayTao || !dh.MaKH) return false;
            const date = h.parseDate(dh.NgayTao);
            return date && date >= startDate;
        });

        const filteredDonHangIds = new Set(filteredDonHangs.map(dh => dh.MaDonHang));
        const filteredChiTiet = db.chiTietDonHangs.filter(ct => filteredDonHangIds.has(ct.MaDonHang));

        // 2. Tính tồn kho cho tất cả sản phẩm
        const tonKhoByProductId = new Map();
        db.chiTietPhieuNhaps.forEach(pn => {
            const currentStock = tonKhoByProductId.get(pn.MaSP) || 0;
            tonKhoByProductId.set(pn.MaSP, currentStock + h.parseNumber(pn.SoLuong));
        });
        db.chiTietDonHangs.forEach(ct => {
            const currentStock = tonKhoByProductId.get(ct.MaSP) || 0;
            tonKhoByProductId.set(ct.MaSP, currentStock - h.parseNumber(ct.SoLuong));
        });

        const sanPhamsWithTonKho = db.sanPhams.map(sp => ({
            ...sp,
            TonKho: tonKhoByProductId.get(sp.MaSP) || 0
        }));

        // 3. Tính toán lại Tổng tiền và Lợi nhuận cho mỗi đơn hàng đã lọc
        const donHangsWithTotals = filteredDonHangs.map(dh => {
            const details = filteredChiTiet.filter(ct => ct.MaDonHang === dh.MaDonHang);
            
            const calculatedTotals = details.reduce((acc, item) => {
                const soLuong = h.parseNumber(item.SoLuong);
                const donGia = h.parseNumber(item.DonGia);
                // Ưu tiên giá nhập hiển thị, nếu không có thì dùng giá nhập gốc
                const giaNhap = h.parseNumber(item.GiaNhapHienThi || item.GiaNhap);

                acc.tongTien += soLuong * donGia;
                acc.loiNhuan += soLuong * (donGia - giaNhap);
                return acc;
            }, { tongTien: 0, loiNhuan: 0 });

            return { ...dh, ...calculatedTotals };
        });

        return { sanPhamsWithTonKho, donHangsWithTotals, filteredChiTiet };
    },

    // --- RENDERING FUNCTIONS ---
    _render() {
        const processedData = this._processData();
        const viewId = this.state.currentView;
        
        // Render nội dung của view hiện tại
        const renderFunction = this[`_render${viewId.charAt(0).toUpperCase() + viewId.slice(1)}`];
        if (renderFunction) {
            renderFunction.call(this, processedData);
        }
    },

    _renderTongQuan({ donHangsWithTotals }) {
        const h = this._helpers;
        const totalDoanhThu = donHangsWithTotals.reduce((sum, dh) => sum + dh.tongTien, 0);
        const totalLoiNhuan = donHangsWithTotals.reduce((sum, dh) => sum + dh.loiNhuan, 0);
        const tyLeLoiNhuan = totalDoanhThu > 0 ? (totalLoiNhuan / totalDoanhThu) * 100 : 0;

        h.updateText('#kpi-doanh-thu', h.formatCurrency(totalDoanhThu));
        h.updateText('#kpi-loi-nhuan', h.formatCurrency(totalLoiNhuan));
        h.updateText('#kpi-don-hang', donHangsWithTotals.length);
        h.updateText('#kpi-ty-le-loi-nhuan', `${tyLeLoiNhuan.toFixed(1)}%`);

        const salesByDay = donHangsWithTotals.reduce((acc, order) => {
            const date = h.parseDate(order.NgayTao);
            if (!date) return acc;
            const dateKey = date.toISOString().split('T')[0];
            acc[dateKey] = acc[dateKey] || { doanhThu: 0, loiNhuan: 0 };
            acc[dateKey].doanhThu += order.tongTien;
            acc[dateKey].loiNhuan += order.loiNhuan;
            return acc;
        }, {});

        const sortedDates = Object.keys(salesByDay).sort();
        
        h.createOrUpdateChart('overviewChart', 'bar', {
            labels: sortedDates,
            datasets: [
                { type: 'bar', label: 'Doanh Thu', data: sortedDates.map(d => salesByDay[d].doanhThu), backgroundColor: 'rgba(245, 158, 11, 0.6)', yAxisID: 'y' },
                { type: 'line', label: 'Lợi Nhuận', data: sortedDates.map(d => salesByDay[d].loiNhuan), borderColor: 'rgb(16, 185, 129)', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true, tension: 0.3, yAxisID: 'y1' }
            ]
        }, {
            responsive: true, maintainAspectRatio: false,
            scales: {
                x: { type: 'time', time: { unit: 'day', tooltipFormat: 'dd/MM/yyyy' } },
                y: { position: 'left', beginAtZero: true, grid: { drawOnChartArea: false } },
                y1: { position: 'right', beginAtZero: true }
            }
        });
    },

    _renderPhanTichBanHang({ filteredChiTiet }) {
        const h = this._helpers;
        const sanPhamMap = this.state.maps.sanPham;
        
        const salesByCategory = filteredChiTiet.reduce((acc, item) => {
            const product = sanPhamMap.get(item.MaSP);
            const category = product ? product.PhanLoai : 'Khác';
            const revenue = h.parseNumber(item.SoLuong) * h.parseNumber(item.DonGia);
            acc[category] = (acc[category] || 0) + revenue;
            return acc;
        }, {});
        
        h.createOrUpdateChart('categorySalesChart', 'doughnut', {
            labels: Object.keys(salesByCategory),
            datasets: [{ data: Object.values(salesByCategory), backgroundColor: ['#f59e0b', '#10b981', '#3b82f6', '#8b5cf6', '#ec4899'] }]
        }, { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } });

        const revenueByProduct = filteredChiTiet.reduce((acc, item) => {
            const revenue = h.parseNumber(item.SoLuong) * h.parseNumber(item.DonGia);
            acc[item.MaSP] = (acc[item.MaSP] || 0) + revenue;
            return acc;
        }, {});

        const sortedProducts = Object.entries(revenueByProduct).sort(([, a], [, b]) => b - a).slice(0, 5);
        
        h.createOrUpdateChart('topProductRevenueChart', 'bar', {
            labels: sortedProducts.map(([maSP]) => (sanPhamMap.get(maSP) || { TenSP: 'N/A' }).TenSP),
            datasets: [{ label: 'Doanh Thu', data: sortedProducts.map(([, revenue]) => revenue), backgroundColor: 'rgba(59, 130, 246, 0.6)' }]
        }, { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } });
    },

    _renderKhoHang({ sanPhamsWithTonKho }) {
        const h = this._helpers;
        const totalValue = sanPhamsWithTonKho.reduce((sum, p) => sum + (p.TonKho * h.parseNumber(p.GiaNhap)), 0);
        const lowStockItems = sanPhamsWithTonKho.filter(p => p.TonKho <= h.parseNumber(p.TonKhoToiThieu));

        h.updateText('#kpi-gia-tri-kho', h.formatCurrency(totalValue));
        h.updateText('#kpi-sap-het-hang', lowStockItems.length);

        const tbody = document.getElementById('lowStockTableBody');
        tbody.innerHTML = ''; // Xóa nội dung cũ một cách an toàn
        
        if (lowStockItems.length === 0) {
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = 3;
            td.className = 'px-4 py-3 text-center text-slate-500';
            td.textContent = 'Không có sản phẩm nào sắp hết hàng.';
            tr.appendChild(td);
            tbody.appendChild(tr);
        } else {
            lowStockItems.forEach(p => {
                const tr = document.createElement('tr');
                tr.className = 'border-b';

                const tdName = document.createElement('td');
                tdName.className = 'px-4 py-3 font-medium';
                tdName.textContent = p.TenSP; // An toàn, không thực thi mã HTML

                const tdStock = document.createElement('td');
                tdStock.className = 'px-4 py-3 text-center font-bold text-rose-500';
                tdStock.textContent = p.TonKho;

                const tdMin = document.createElement('td');
                tdMin.className = 'px-4 py-3 text-center';
                tdMin.textContent = p.TonKhoToiThieu;

                tr.append(tdName, tdStock, tdMin);
                tbody.appendChild(tr);
            });
        }
    },
    
    _renderKhachHang({ donHangsWithTotals }) {
        const h = this._helpers;
        const khachHangMap = this.state.maps.khachHang;

        const spendingByCustomer = donHangsWithTotals.reduce((acc, order) => {
            acc[order.MaKH] = (acc[order.MaKH] || 0) + order.tongTien;
            return acc;
        }, {});

        const sortedCustomers = Object.entries(spendingByCustomer).sort(([, a], [, b]) => b - a).slice(0, 5);

        h.createOrUpdateChart('topCustomerChart', 'bar', {
            labels: sortedCustomers.map(([maKH]) => (khachHangMap.get(maKH) || { TenKH: 'N/A' }).TenKH),
            datasets: [{ label: 'Tổng Chi Tiêu', data: sortedCustomers.map(([, spending]) => spending), backgroundColor: 'rgba(16, 185, 129, 0.6)' }]
        }, { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } });

        const newCustomerIds = new Set(donHangsWithTotals.map(d => d.MaKH));
        h.updateText('#total-customers', this.state.database.khachHangs.length);
        h.updateText('#new-customers', newCustomerIds.size);
    },

    // --- EVENT HANDLERS & INITIALIZATION ---
    _showView(viewId) {
        if (!viewId) viewId = 'tongQuan';
        this.state.currentView = viewId;

        const viewsContainer = document.getElementById('views-container');
        const template = document.getElementById(`view-template-${viewId}`);
        if (!template) {
            console.error(`Không tìm thấy template cho view: ${viewId}`);
            return;
        }
        
        // Cập nhật nội dung và tiêu đề
        viewsContainer.innerHTML = ''; // Xóa nội dung cũ
        viewsContainer.appendChild(template.content.cloneNode(true));
        
        const titles = {
            tongQuan: 'Dashboard Tổng Quan',
            phanTichBanHang: 'Phân Tích Bán Hàng',
            khoHang: 'Báo Cáo Kho Hàng',
            khachHang: 'Phân Tích Khách Hàng'
        };
        this._helpers.updateText('#view-title', titles[viewId]);

        // Cập nhật trạng thái active cho navigation
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('bg-amber-50', 'border-b-4', 'sm:border-b-0', 'sm:border-r-4', 'border-amber-500', 'text-amber-600');
            link.classList.add('text-slate-600');
        });
        const activeLink = document.querySelector(`.nav-link[href="#${viewId}"]`);
        if(activeLink){
            activeLink.classList.add('bg-amber-50', 'border-b-4', 'sm:border-b-0', 'sm:border-r-4', 'border-amber-500', 'text-amber-600');
        }
        
        // Render dữ liệu cho view mới
        this._render();
    },

    _setupEventListeners() {
        document.getElementById('date-filter').addEventListener('change', () => this._render());
        
        document.getElementById('main-nav').addEventListener('click', (e) => {
            const navLink = e.target.closest('.nav-link');
            if (navLink) {
                e.preventDefault();
                const viewId = navLink.getAttribute('href').substring(1);
                this._showView(viewId);
            }
        });
    },

    init() {
        if (this._loadDataFromUrl()) {
            this._createLookupMaps();
            this._setupEventListeners();

            document.getElementById('loading-state').classList.add('hidden');
            const appContainer = document.getElementById('app-container');
            appContainer.classList.remove('hidden');
            appContainer.classList.add('flex');
            
            // Lấy view từ hash URL hoặc mặc định là tongQuan
            const initialView = window.location.hash ? window.location.hash.substring(1) : 'tongQuan';
            this._showView(initialView);
        }
    }
};

// Khởi chạy ứng dụng khi trang đã tải xong
window.onload = () => {
    DashboardApp.init();
};
</script>

</body>
</html>
